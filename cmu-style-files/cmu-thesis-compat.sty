%% ``subfigure'' legacy code:
%%\RequirePackage{subfigure}
%%\renewcommand{\@subcaption}[3]{\@nameuse{@make#1caption}{\@nameuse{@the#1}}{#3}}

%% When using hyperref we want:
%% 1) The link borders disabled
%% 2) The default printing settings to not scale the document and to
%%    automatically duplex the document if it is two-sided.
%% 3) To import the document information, currently:
%%  (a) The title
%%  (b) The author
%% NEW! Method (1), support hyperref included before the template:
\@ifpackageloaded{hyperref}{
	\Hy@unicodefalse
	\Hy@breaklinkstrue
	\def\@pdfborder{0 0 0}
	\def\@pdfprintscaling{None}
	\global\let\cmu@hyperref=\@true%
}{}
%% NEW! Method (2), support hyprref included after the template (allows users to override options if they wish):
\global\let\internal@usepackage=\usepackage
\gdef\usepackage{%
	\@ifnextchar[%
	{\internal@usepackage}%
	{\usepackage@}%
}
\gdef\custom@usepackage@hyperref{%
	\internal@usepackage[breaklinks=true,pdfborder={0 0 0},pdfprintscaling=None]{hyperref}
	\AtBeginDocument{
		\cmu@pdf@title{\@title} %% See cmu-thesis-title.sty
		\hypersetup{%
			pdftitle = {\@cmu@pdf@title},
			pdfkeywords = {},
			pdfauthor = {\@author}
		}
	}
}
\gdef\usepackage@#1{
	\expandafter\ifx\csname custom@usepackage@#1\endcsname\relax%
		\internal@usepackage{#1}%
	\else%
		\csname custom@usepackage@#1\endcsname%
	\fi%
}
%% OLD Method (call new method):
\newcommand{\usehyperref}{\custom@usepackage@hyperref}

%% Define the list of expected citation styles (in case multibib isn't used)
\cmu@AtEndPreamble{%
	\@ifundefined{@mb@citenamelist}%
		{\def\@mb@citenamelist{cite,citep,citet,citealp,citealt}}%
		{\relax}%
}

%% Detect when bibliographies are being used for each chapter, make them compatible, and demote them to subsections
\global\let\cmu@chapter@bibliography=\@false
\global\let\cmu@bibtopic=\@false
\cmu@AtEndPreamble{
	% The chapterbib package already pretty much does what we want
	\@ifpackageloaded{chapterbib}{
		\global\let\cmu@chapter@bibliography=\@true
	}{}
	% The bibtopic package is more flexible than chapterbib (and used by LyX), but requires more effort to get going
	\@ifpackageloaded{bibtopic}{
		\ifx\cmu@disallow@bibtopic\@true\relax
			\cmu@bibtopic@override % Can't use bibtopic with unsorted styles
			\AtBeginDocument{%
				\cmu@bibtopic@override@%
				%\cmu@citehack@set{\jobname.1}% not necessary (until set we'll use the default aux file)
			}
		\else
			\cmu@bibtopic@compat
		\fi
	}{}
}

%% bibtopic is not compatible with unsorted styles, override the hell out of it:
\global\let\cmu@citehack@frontmatter\@true
\gdef\cmu@bibtopic@override{%
	% define the bibliography command back to normal (bibtopic kills it)
	\def\bibliography##1{%
		\if@filesw
			\immediate\write\@auxout{\string\bibdata{##1}}%
		\fi
		\@input@{\jobname.bbl}%
	}%
	\global\let\citation\@bt@orig@citation%
	\global\let\bibliographystyle\@orig@bibliographystyle%
	\global\let\bibitem\bt@saveitem%
    \global\let\thebibliography\bt@savebib%
    \global\let\endthebibliography\bt@endsavebib%
	\usepackage[resetlabels]{multibib}%
	\newcounter{cmu@multibib@i}%
	\global\let\cmu@hack@newcites\newcites
	\g@addto@macro\cmu@chapter@hook{%
		\global\let\cmu@citehack@frontmatter\@false%
		\stepcounter{cmu@multibib@job}%
		\edef\cmu@suffix{\jobname.\arabic{cmu@multibib@job}}%
		\cmu@hack@newcites{\cmu@suffix}{Chapter Literature}%
		\cmu@citehack@set{\cmu@suffix}%\jobname.\arabic{cmu@multibib@job}}%
		% Allow access to citation data in the frontmatter:
		\edef\cmu@tmpname{{\cmu@suffix.aux}}%
		\expandafter\cmu@citehack@preamble\cmu@tmpname%
	}%
	\renewenvironment{btUnit}{}{}%
	\renewenvironment{btSect}[2][\cmu@bibliographystyle]{%
		\gdef\cmu@multibib@bibliographystyle{##1}%
		\gdef\cmu@multibib@bibliographies{##2}%
	}{}%
	\renewcommand{\btPrintCited}{%
		\expandafter\csname bibliographystyle\cmu@citehack@currentlabel\endcsname{\cmu@multibib@bibliographystyle}%
		\expandafter\csname bibliography\cmu@citehack@currentlabel\endcsname{\cmu@multibib@bibliographies}%
	}%
}
\gdef\cmu@citehack@preamble#1{%
	\AtEndDocument{%
		\immediate\write\@mainaux{\string\@input{#1}}%
	}%
}
\newcounter{cmu@multibib@job}
\gdef\cmu@citehack@set@A#1#2{%
	% pattern \global\let\cmu@citehack@orig@multibib@<<1>><<2>>@\<<1>><<2>> :
	\ifcsname cmu@citehack@orig@multibib@#1#2@\endcsname\else%
		\expandafter\expandafter\expandafter\global\expandafter\expandafter\expandafter\let\expandafter\csname cmu@citehack@orig@multibib@#1#2@\expandafter\endcsname\csname #1#2\endcsname%
	\fi%
}
\gdef\cmu@citehack@set@B#1#2{%
	% pattern \global\let\<<1><<2>>\cmu@citehack@current@<<1>>@ :
	%\expandafter\expandafter\expandafter\global\expandafter\expandafter\expandafter\let\expandafter\csname #1#2\expandafter\endcsname\csname cmu@citehack@current@#1@\endcsname%
	% pattern \gdef\<<1>><2>> :%
	\expandafter\gdef\csname #1#2\endcsname{%
		\global\let\cmu@citehack@on\@false%
		\csname cmu@citehack@orig@multibib@#1#2@\endcsname%
	}%
}
\gdef\cmu@citehack@set@#1#2{%
	\cmu@citehack@set@A{#1}{#2}%
	\cmu@citehack@set@B{#1}{#2}%
	% pattern \gdef\cmu@citehack@currentlabel@ :
	\gdef\cmu@citehack@currentlabel{#2}%
	% pattern \gdef\cmu@citehack@current@<<1>>@ :
	%\expandafter\expandafter\expandafter\gdef\expandafter\csname cmu@citehack@current@#1@\endcsname{%
	\expandafter\gdef\csname cmu@citehack@current@#1@\endcsname{%
		\global\let\cmu@citehack@on\@false%
		\csname cmu@citehack@orig@multibib@#1#2@\endcsname%
	}%
}
\gdef\cmu@citehack@set#1{%
	\edef\cmu@tmpname@b{{#1}}%
	\@for\@citename:=\@mb@citenamelist\do{%
		\edef\cmu@tmpname@a{{\@citename}}%
		% pattern \cmu@citehack@set@{\@citename}{#1} :
		\expandafter\expandafter\expandafter\cmu@citehack@set@\expandafter\cmu@tmpname@a\cmu@tmpname@b%
	}%
}
% pattern \global\let\cmu@citehack@orig@<<1>>@\<<1>> :
\gdef\cmu@citehack@setcommand#1{%
	\expandafter\expandafter\expandafter\global\expandafter\expandafter\expandafter\let\expandafter\csname cmu@citehack@orig@#1@\expandafter\endcsname\csname #1\endcsname%
}
% pattern \global\let\cmu@citehack@magic\cmu@citehack@orig@<<1>>@ :
\gdef\cmu@citehack@getcommand#1{%
	\expandafter\let\expandafter\cmu@citehack@magic\csname cmu@citehack@orig@#1@\endcsname%
}
% pattern \global\let\cmu@citehack@magic\cmu@citehack@current@<<1>>@ :
\gdef\cmu@citehack@getcommand@#1{%
	\expandafter\let\expandafter\cmu@citehack@magic\csname cmu@citehack@current@#1@\endcsname%
}
% explore for putting citation in both the main aux file and each chapter:
%  \let\std@@citex\@citex
%  \mb@@citex
% alternative:
% \@input each aux file in the main aux file
\gdef\cmu@bibtopic@override@@#1{%
%#1\space% diagnostic
	\expandafter\cmu@citehack@setcommand{#1}%
	\expandafter\gdef\csname cmu@citehack@#1\endcsname{%
		\ifx\cmu@citehack@frontmatter\@true\relax%
			\expandafter\let\expandafter\cmu@citehack@magic\csname cmu@eat@#1@\endcsname%
		\else%
			\ifx\cmu@citehack@on\@true\relax%
				\expandafter\cmu@citehack@getcommand@{#1}%
%#1\space% diagnostic
			\else%
				\global\let\cmu@citehack@on\@true%
				\expandafter\cmu@citehack@getcommand{#1}%
			\fi%
		\fi%
	}%
	%\expandafter\gdef\csname cmu@citehack@new@#1@\endcsname{%
	\expandafter\gdef\csname #1\endcsname{%
%#1\space% diagnostic
		\cmu@citehack@getcommand{#1}%
		\expandafter\protect\csname cmu@citehack@#1\endcsname% this command will not be processed for captions (very important)
		\cmu@citehack@magic%
	}
	%\expandafter\expandafter\expandafter\global\expandafter\expandafter\expandafter\let\expandafter\csname #1\expandafter\endcsname\csname cmu@citehack@new@#1@\endcsname%
}
\global\let\cmu@within@list\@true%
\gdef\cmu@bibtopic@override@{
	\global\let\cmu@chapter@bibliography=\@true%
	\global\let\cmu@citehack@on\@true%
	\@for\@citename:=\@mb@citenamelist\do{%
		\edef\cmu@tmpname{{\@citename}}%
		\expandafter\cmu@bibtopic@override@@\cmu@tmpname%
	}%
}

%% bibtopic is just fine for ``normal'' styles, just make some compatibility tweaks:
\gdef\cmu@bibtopic@compat{
	\global\let\cmu@bibtopic=\@true
	\global\let\cmu@chapter@bibliography=\@true
	\global\let\cmu@orig@btPrintCited=\btPrintCited
	\global\let\cmu@orig@btSect=\btSect
	\renewcommand{\btSect}{%
		% TODO: finish this up at little bit for author-date people
		\ifx\cmu@bibliographystyle@found\@false\relax%
			%\expandafter\cmu@orig@bibliographystyle{\cmu@bibliographystyle}%
			%\cmu@bibliographystyle%
		\fi%
			%\expandafter\cmu@orig@bibliographystyle{unsrtnat}%
		\cmu@orig@btSect%
	}
	\renewcommand{\btPrintCited}{%
		\begingroup%
			\cmu@internal@bibliography%
			\cmu@internal@bibliography@%
			\cmu@internal@bibliography@@@%
			\cmu@orig@btPrintCited%
		\endgroup%
	}
	\global\let\cmu@bibtopic@within@chapter=\@false%
	\g@addto@macro\cmu@chapter@hook{%
		\ifx\cmu@bibtopic@within@chapter\@true\relax%
			\endbtUnit%
		\fi%
		\ifx\cmu@bibtopic\@true\relax%
			\global\let\cmu@bibtopic@within@chapter=\@true%
			\global\let\cmu@bibliographystyle@found=\@false%
			\btUnit%
		\fi%
	}
	\g@addto@macro\cmu@backmatter@hook{%
		\ifx\cmu@bibtopic@within@chapter\@true\relax%
			\endbtUnit%
		\fi%
	}
}